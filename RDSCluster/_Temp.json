{
  "apiVersion": "2015-06-15",
  "type": "Microsoft.Compute/virtualMachines/extensions",
  "name": "[concat('rdsh-', copyindex(),'/sessionhost')]",
  "location": "[resourceGroup().location]",
  "dependsOn": [
    "[resourceId('Microsoft.Compute/virtualMachines', concat('rdsh-', copyindex()))]"
  ],
  "properties": {
    "publisher": "Microsoft.Powershell",
    "type": "DSC",
    "typeHandlerVersion": "2.11",
    "autoUpgradeMinorVersion": true,
    "settings": {
      "ModulesUrl": "[concat(variables('assetLocation'),'/Configuration.zip')]",
      "ConfigurationFunction": "Configuration.ps1\\SessionHost",
      "Properties": {
        "DomainName": "[parameters('adDomainName')]",
        "AdminCreds": {
          "UserName": "[parameters('adminUsername')]",
          "Password": "PrivateSettingsRef:AdminPassword"
        }
      }
    },
    "protectedSettings": {
      "Items": {
        "AdminPassword": "[parameters('adminPassword')]"
      }
    }
  }
}




{
  "type": "Microsoft.Compute/virtualMachines/extensions",
  "name": "cb-vm/rdsdeployment",
  "apiVersion": "2015-06-15",
  "location": "[resourceGroup().location]",
  "dependsOn": [
    "[resourceId('Microsoft.Compute/virtualMachines', 'cb-vm')]",
    "Microsoft.Compute/virtualMachines/gw-vm/extensions/gateway",
    "rdsh-vm-loop"
  ],
  "properties": {
    "publisher": "Microsoft.Powershell",
    "type": "DSC",
    "typeHandlerVersion": "2.11",
    "autoUpgradeMinorVersion": true,
    "settings": {
      "ModulesUrl": "[concat(variables('assetLocation'),'/Configuration.zip')]",
      "ConfigurationFunction": "Configuration.ps1\\RDSDeployment",
      "Properties": {
        "adminCreds": {
          "UserName": "[parameters('adminUsername')]",
          "Password": "PrivateSettingsRef:adminPassword"
        },
        "connectionBroker": "[concat('broker.',parameters('adDomainName'))]",
        "domainName": "[parameters('adDomainName')]",
        "externalfqdn": "[concat('gateway.',parameters('adDomainName'))]",
        "numberOfRdshInstances": "[parameters('numberOfRdshInstances')]",
        "sessionHostNamingPrefix": "rdsh-",
        "webAccessServer": "[concat('gateway.',parameters('adDomainName'))]"
      }
    },
    "protectedSettings": {
      "Items": {
        "adminPassword": "[parameters('adminPassword')]"
      }
    }
  }
}




